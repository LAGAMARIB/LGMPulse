@using LGMDomains.Common.Helpers;
@using LGMPulse.WebApp.Models
@model RelatoriosViewModel
@{
    Layout = "_Layout";
    ViewBag.Title = "PULSE Relatórios";
    int month = Model.Month;
    int year = Model.Year;
}

@section style {
    <style>
        #topBar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: .75rem 1rem;
            font-size: 18px;
            background: linear-gradient(145deg, var(--add-bg-start), var(--add-bg-end));
            color: var(--add-text);
        }

        .menu-toggle {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.4rem;
            cursor: pointer;
        }

        #relatoriosMenu {
            position: absolute;
            top: 5.2rem;
            left: 1rem;
            padding: .5rem;
            border-radius: 6px;
            box-shadow: 0 8px 20px rgba(0,0,0,.35);
            transition: opacity .2s ease, transform .2s ease;
            background: linear-gradient(145deg, var(--add-bg-start), var(--add-bg-end));
            color: var(--add-text);
            z-index: 2;        }

            #relatoriosMenu.collapsed {
                opacity: 0;
                pointer-events: none;
                transform: translateY(-10px);
            }

        .relat-option {
            display: block;
            width: 100%;
            background: none;
            border: none;
            padding: .5rem .75rem;
            text-align: left;
            cursor: pointer;
            font-size: 18px;
        }

            .relat-option:hover {
                background: rgba(255,255,255,.08);
            }

        /* ===== MÊS ===== */

        .relat-navigate {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: linear-gradient(145deg, var(--section-begin), var(--section-end));
            padding: 12px 16px;
            border-radius: 15px;
            margin-top: 1rem;
        }

        #currentMonthLabel {
            flex: 1;
            text-align: center;
            font-weight: 500;
            user-select: none;
            white-space: nowrap;
        }

        .month-btn {
            font-size: 1.9rem;
            cursor: pointer;
            opacity: 0.75;
            transition: transform .15s ease, opacity .15s ease;
        }

            .month-btn:hover {
                opacity: 1;
            }

            .month-btn:active {
                transform: scale(0.9);
            }

    </style>
}

<div id="topBar">
    <button id="btnToggleRelatorios" class="menu-toggle" aria-label="Abrir menu de relatórios">
        <i class="fas fa-bars"></i>
    </button>
    <span class="title">Relatórios</span>
    <span class="subtitle" id="subTitle"></span>
</div>

<div id="relatoriosMenu" class="collapsed">
    <button class="relat-option" data-rel="grupos">Visão por Grupo</button>
    <button class="relat-option" data-rel="evolucao">Evolução Mensal</button>
    <button class="relat-option" data-rel="mapafinanceiro">Mapa Financeiro</button>
</div>

<div class="relat-navigate">
    <i class="fas fa-chevron-left month-btn" id="prevMonth"></i>

    <span id="currentMonthLabel">@Model.MesReferencia</span>

    @if (!Model.IsMesAtual)
    {
        <i class="fas fa-chevron-right month-btn" id="nextMonth"></i>
    }
</div>

<div id="relatoriosFrame">

</div>

@section script {
    <script>
        let currentYear = @Model.Year;
        let currentMonth = @Model.Month;
        let currentReport = "";

        $(document).on("click", "#prevMonth", function () {
            navigateMonth(-1);
        });

        $(document).on("click", "#nextMonth", function () {
            navigateMonth(1);
        });

        function navigateMonth(offset) {
            if (currentReport === "mapafinanceiro") {
                currentYear += offset;
            } else {
                currentMonth += offset;
            }

            if (currentMonth === 0) {
                currentMonth = 12;
                currentYear--;
            }

            if (currentMonth === 13) {
                currentMonth = 1;
                currentYear++;
            }

            window.location.href = `/relatorios/${currentYear}/${currentMonth}`;
        }

        function carregarRelatorio(nome, subtitle) {
            const url = `/relatorios/${nome}/${currentYear}/${currentMonth}`;
            $.get(url, function (resp) {
                if (resp) {
                    $('#relatoriosFrame').html(resp);
                    currentReport = nome;

                    if (currentReport === "mapafinanceiro") {
                        $('#currentMonthLabel').text(currentYear);
                    }

                    if (subtitle) {
                        $('#subTitle').html(` - ${subtitle}`)
                    }
                    localStorage.setItem('ultimoRelatorio', nome);
                    localStorage.setItem('ultimoRelatorioLabel', subtitle);
                }
            });
        }

        $('#btnToggleRelatorios').on('click', function () {
            $('#relatoriosMenu').toggleClass('collapsed');
        });

        $('.relat-option').on('click', function () {
            const rel = $(this).data('rel');
            const subtitle = $(this).text().trim();
            carregarRelatorio(rel, subtitle);
            $('#relatoriosMenu').addClass('collapsed');
        });

        $(document).ready(function () {
            const ultimo = localStorage.getItem('ultimoRelatorio');
            const label = localStorage.getItem('ultimoRelatorioLabel');

            if (ultimo === "mapafinanceiro") {
                $('#currentMonthLabel').text(currentYear);
            }

            if (ultimo) {
                carregarRelatorio(ultimo, label);
            } else {
                carregarRelatorio('grupos', 'Visão por Grupo');
            }

            DisableIcon(3);
        });
    </script>
}