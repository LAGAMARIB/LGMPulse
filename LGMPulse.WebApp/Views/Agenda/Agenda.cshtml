@using LGMDomains.Common.Helpers
@using LGMPulse.Domain.Domains
@using LGMPulse.Domain.Enuns
@using LGMPulse.WebApp.Models
@model AgendaViewModel
@{
    Layout = "_Layout";
    ViewBag.Title = ViewBag.Title ?? "Agendamento";

    string[] callendHeader = { "D", "S", "T", "Q", "Q", "S", "S" };
    int[,] calendMonth = new int[6, 7];
    int dateMonth = Model.Month;
    int dateYear = Model.Year;
    int calendWeek = 0;
    decimal? totalReceitas_Prev = 0;
    decimal? totalDespesas_Prev = 0;
    string classFree = Model.HasFreeRestrict ? "freeMode" : "";

    DateTime date = new DateTime(dateYear, dateMonth, 01);
    int calendDay = ((int)date.DayOfWeek);
    while (date.Month == dateMonth)
    {
        calendMonth[calendWeek, calendDay] = date.Day;
        date = date.AddDays(1);
        calendDay += 1;
        if (calendDay > 6)
        {
            calendWeek += 1;
            calendDay = 0;
        }
    }
    ;

    foreach (Agenda agenda in Model.Agendas)
    {
        if (agenda.TipoMovto == TipoMovtoEnum.Despesa)
            totalDespesas_Prev += agenda.ValorParcela;
        else
            totalReceitas_Prev += agenda.ValorParcela;
    }
}

@section style {
    <style>
        #navCalendar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-2);
            width: 100%;
            max-width: 360px;
            margin: 10px auto 6px;
        }

            #navCalendar button {
                background: var(--pulse-blue);
                color: var(--branco-neve);
                border-radius: 14px;
                font-size: 1.1rem;
                padding: 10px 18px;
                font-weight: 700;
                box-shadow: 0 4px 12px rgba(0,0,0,.2);
                height: 50px;
            }

            #navCalendar span {
                font-size: 1.5rem;
                font-weight: 700;
            }

            #navCalendar button.freeMode {
                background: var(--pulse-blue-alpha);
            }

        #divToolCalendar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 500px;
            margin: auto;
            padding: 0 10px;
        }

            #divToolCalendar button {
                padding: 6px;
                width: 100%;
                height: 50px;
                background-color: var(--btn-success-bg);
                color: var(--btn-success-color);
                border-radius: 8px;
                font-size: 18px;
            }

                #divToolCalendar button i {
                    margin: 0 5px 0 15px;
                    font-size: 2em;
                }

        #btnDelayed {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px !important;
            background-color: var(--btn-danger-bg) !important;
        }

        #tableCalendar {
            width: 100%;
            max-width: 360px;
            margin: 8px auto;
            font-weight: 600;
            font-size: 1.1rem;
            background: var(--background-light);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border-collapse: separate;
            border-spacing: 6px;
            padding: 0; /* ⬅️ remove o espremedor */
        }

            #tableCalendar th,
            #tableCalendar td {
                aspect-ratio: 1 / 1;
                text-align: center;
                vertical-align: middle;
                border-radius: 10px;
                color: var(--color-text-body);
            }

            #tableCalendar th {
                padding: 5px;
            }

                #tableCalendar td:first-child,
                #tableCalendar th:first-child,
                #tableCalendar td:last-child,
                #tableCalendar th:last-child {
                    color: var(--cor-despesa);
                }

            #tableCalendar thead {
                position: relative;
            }

            #tableCalendar thead,
            #tableCalendar tbody,
            #tableCalendar tr {
                width: 100%;
            }

            #tableCalendar td.hasContent span {
                background: var(--branco-transparente);
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                margin: 4px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: transform .15s ease, background .15s ease, box-shadow .15s ease;
            }

            #tableCalendar td.hasContent:hover span {
                background: rgba(255,255,255,.75);
                box-shadow: inset 0 0 0 1px var(--border-soft);
            }

            #tableCalendar td.hasContent:active span {
                transform: scale(0.9);
                filter: brightness(1.15);
                box-shadow: 0 0 6px rgba(0,0,0,0.25) inset;
            }

            #tableCalendar td.hasContent:focus-visible span {
                outline: none;
                box-shadow: 0 0 0 2px var(--cor-icone-acao-hover);
                transform: scale(0.96);
            }

            #tableCalendar td.hasContent.isToday {
                border: 2px solid var(--cor-despesa);
            }

            #tableCalendar td.hasContent span.selected {
                background-color: var(--color-link);
                color: var(--cor-texto-botao);
            }

            #tableCalendar td.hasOpen span {
                background-color: var(--bill-late-color);
                color: var(--branco-neve);
            }

            #tableCalendar td.hasIncome span {
                background-color: var(--cor-receita);
                color: var(--branco-neve);
            }

        .containerCalendar {
            display: flex;
            flex-direction: column;
            height: 47vh;
            margin-top: 3rem;
        }

        .divSumary {
            width: 100%;
            max-width: 360px;
            margin: 14px auto;
            background: var(--background-light);
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            padding: var(--space-2);
        }

        .itemTotal {
            display: grid;
            grid-template-columns: 50px 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px dashed var(--background-border);
            margin-bottom: 6px;
        }

            .itemTotal:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }

            .itemTotal i {
                font-size: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .itemTotal span {
                font-size: 1.05rem;
            }

                .itemTotal span:nth-child(2) {
                    font-weight: bold;
                }

                .itemTotal span:last-child {
                    font-size: 1.15rem;
                    font-weight: bold;
                    text-align: right;
                }

        .valReceita {
            color: var(--cor-receita);
        }

        .valDespesa {
            color: var(--cor-despesa);
        }
    </style>
}

<div class="containerCalendar">
    <div id="divCalendar">
        <nav id="navCalendar">
            <button type="button" id="prevMonth" class="btn btn-primary btn-sm">&lt;</button>
            
            <span>@DateTimeHelper.MesReferencia(Model.Year, Model.Month)</span>
            
            <button type="button" id="nextMonth" class="btn btn-primary btn-sm @classFree">&gt;</button>
        </nav>
        <table id="tableCalendar">
            <thead>
                <tr>
                    @foreach (string dayWeek in callendHeader)
                    {
                        <th>@dayWeek</th>
                    }
                </tr>
            </thead>
            <tbody>
                @for (var i = 0; i < 6; i++)
                {
                    <tr>
                        @for (var j = 0; j < 7; j++)
                        {
                            var day = calendMonth[i, j];
                            if (day > 0)
                            {
                                var today = DateTime.Today;
                                var dateCell = new DateTime(Model.Year, Model.Month, day);
                                var isToday = (dateCell == today) ? "isToday" : "";
                                var hasOpen = Model.Agendas.Exists(x => x.DataVencto?.Date == dateCell.Date);
                                var hasOpenClass = hasOpen ? "hasOpen" : "";
                                var hasIncomeClass = Model.Agendas.Exists(x => x.DataVencto?.Date == dateCell.Date && x.TipoMovto == TipoMovtoEnum.Receita) ? "hasIncome" : "";
                                <td class="hasContent
                                    @isToday @hasOpenClass @hasIncomeClass"
                                    data-value="@dateCell.ToString("yyyy-MM-dd")">
                                    <span>@day</span>
                                </td>
                            }
                            else
                            {
                                <td></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="divSumary">
        <div class="itemTotal valReceita">
            <i class="fas fa-money-bill-alt"></i>
            <span>A Receber</span>
            <span>@(string.Format("{0:C2}", totalReceitas_Prev))</span>
        </div>
        <div class="itemTotal valDespesa">
            <i class="fas fa-money-bill-alt"></i>
            <span>A Pagar</span>
            <span>@(string.Format("{0:C2}", totalDespesas_Prev))</span>
        </div>
    </div>

    <div id="divToolCalendar">
        @if (Model.HasDelayed)
        {
            <button type="button" id="btnDelayed">
                <span>Existe parcela pendente em mês anterior</span>
            </button>
        }
    </div>
</div>

@section script {
    <script>
        $(function() {
            const currentMonth = @Model.Month;
            const currentYear = @Model.Year;

            function ShowLimiteParcelasMessage() {
                const titulo = "O futuro já está no seu radar";
                const mens = `
                    <p>
                        No <strong>Pulse gratuito</strong>, você pode planejar compromissos
                        para o mês atual e o próximo — o suficiente para manter o controle
                        do curto prazo.
                    </p>
                    <br>
                    <p>
                        A partir daí, o planejamento de médio e longo prazo fica disponível
                        na <strong>versão completa</strong>, onde você pode agendar com mais
                        parcelas e mais meses à frente, com total liberdade.
                    </p>
                `;
                ShowFreeModeModal(titulo, mens);
            }

            $('#prevMonth, #btnDelayed').on('click', function() {
                var newMonth = currentMonth - 1;
                var newYear = currentYear;
                if (newMonth < 1) {
                    newMonth = 12;
                    newYear = currentYear - 1;
                }
                window.location.href = `/agenda/${newYear}/${newMonth}`;
            });

            @if (Model.HasFreeRestrict) 
            {
                <text>
                $('#nextMonth').on('click', function() {
                    ShowLimiteParcelasMessage();
                });
                </text>
            }
            else 
            {
                <text>
                $('#nextMonth').on('click', function() {
                    var newMonth = currentMonth + 1;
                    var newYear = currentYear;
                    if (newMonth > 12) {
                        newMonth = 1;
                        newYear = currentYear + 1;
                    }
                    window.location.href = `/agenda/${newYear}/${newMonth}`;
                });
                </text>
            }

            $('td.hasContent').on('click', function() {
                const id = $(this).data('value');
                window.location.href = `/agenda/gradeagenda/dia/${id}`;
            });

        });

        $(document).ready(function () {
            DisableIcon(2);
        });
    </script>
}