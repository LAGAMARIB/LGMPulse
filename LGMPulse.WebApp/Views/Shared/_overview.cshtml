@using LGMDomains.Common.Helpers
@{
    Layout = "_Layout";
    DateTime hoje = DateTimeHelper.Now();
    DateTime _overview_dataLancto = ViewBag.DataLancto != null ? ViewBag.DataLancto : hoje;
    bool _overview_IsMesAtual = _overview_dataLancto.Year == hoje.Year && _overview_dataLancto.Month == hoje.Month;
    bool _overview_IsMesAnterior = _overview_dataLancto.Year < hoje.Year || (_overview_dataLancto.Year == hoje.Year && _overview_dataLancto.Month < hoje.Month);
    bool isAgenda = (ViewBag.IsAgenda != null && ViewBag.IsAgenda);
    string urlBase = isAgenda ? "agenda" : "lancamento";
    string acao = isAgenda ? "Agendar" : "Nova";
    bool IsFreeMode = ViewBag.Session?.User?.SubscriptLevel != null ? ViewBag.Session?.User?.SubscriptLevel == 0 : true;
}


@section style {
    <style>
        /* Casca geral do overview */
        .overview-shell {
            position: relative;
            height: calc( 100dvh - var(--header-height) - var(--footer-height) );
            display: flex;
            flex-direction: column;
        }

        /* Área que cresce exatamente até o botão */
        .overview-content {
            flex: 1;
            overflow: hidden;
            padding-bottom: calc(var(--footer-height) + 110px);
        }

        /* Overlay */
        #addOverlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            transform: translateY(100%);
            background: var(--overlay-dark);
            transition: transform 360ms cubic-bezier(.22,.9,.32,1);
            display: flex;
            flex-direction: column; /* 🔑 */
            align-items: stretch; /* 🔑 */
            overflow: hidden;
            z-index: 30;
        }

            /* quando ativo */
            #addOverlay.active {
                transform: translateY(0);
            }

                /* esconder o botão (suavemente) enquanto overlay sobe */
                #addOverlay.active + #addButton {
                    transform: translateX(-50%) translateY(-400px);
                    opacity: 0; /* some depois de subir */
                    pointer-events: none;
                }


            /* container interno do overlay */
            #addOverlay .overlay-content {
                position: relative;
                width: 100%;
                height: 100%;
            }

        .overlay-topbar {
            position: relative;
            width: 100%; /* 🔑 */
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
            padding: 0 16px;
            flex-shrink: 0;
        }

        /* Botão-aba flutuante */

        #addButton {
            position: fixed;
            bottom: calc(var(--footer-height));


            left: 50%;
            transform: translateX(-50%);

            width: 160px;
            height: 86px;

            border-top-left-radius: 28px;
            border-top-right-radius: 28px;

            background: linear-gradient(145deg, var(--add-bg-start), var(--add-bg-end));
            color: var(--add-text);

            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;

            font-size: 2.4rem;
            font-weight: 700;

            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.22);

            z-index: 20;
            transition: transform 220ms cubic-bezier(.22,.9,.32,1), box-shadow 220ms ease;
        }

        @@media (max-width: 768px) {
            #addButton {
                left: 50%;
                transform: translateX(-50%);
            }

            .overview-content {
                padding-bottom: calc(var(--footer-height) + 100px);
            }
        }

        /* toque */
        #addButton:active {
            transform: translateX(-50%) scale(0.96);
            box-shadow: 0 4px 10px rgba(0,0,0,.25);
        }

        #mesReferencia {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: var(--branco-neve);
            font-weight: 700;
            font-size: 1.5rem;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1;
        }

        .period-badge {
            margin-left: 10px;
            padding: 0;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: var(--badge-text-color);
            background: var(--badge-back-color);
            border-radius: 999px;
            box-shadow: inset 0 0 0 1px var(--preto-sombra-2);
            user-select: none;
            white-space: nowrap;
        }

        /* botão fechar */
        #closeOverlayButton {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #ffb5b5, #ff6e6e);
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
        }


            #closeOverlayButton:hover {
                transform: scale(1.06);
            }

            #closeOverlayButton:active {
                transform: scale(0.92);
            }

            #closeOverlayButton img.close-icon {
                width: 22px;
                height: 22px;
                filter: brightness(0) invert(1); /* deixa o ícone branco automaticamente */
            }

        /* tela de overlay */
        #overlayHome {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .overlay-option {
            width: 80%;
            padding: 2rem;
            font-size: 2rem;
            border-radius: 18px;
            border: none;
            cursor: pointer;
            background: var(--footer-bg);
            color: var(--add-text);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transition: transform .18s ease;
        }

            .overlay-option:active {
                transform: scale(0.97);
            }

        #overlayFrame {
            display: none;
            width: 100%;
            height: 100%;
            border: none;
        }

        #backOverlayButton {
            width: 40px;
            height: 40px;
            background: var(--footer-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            z-index: 2;
        }

        #btnReceita {
            background: linear-gradient(145deg, var(--sphere-income-start), var(--sphere-income-end));
        }

        #btnDespesa {
            background: linear-gradient(145deg, var(--sphere-expense-start), var(--sphere-expense-end));
        }

        /* campos avançados */
        #btnAdvancedFields {
            position: absolute;
            bottom: 85px;
            right: 15px;
            width: 53px;
            height: 53px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.20);
            backdrop-filter: blur(2px);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 1.6rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
            z-index: 35;
        }

            #btnAdvancedFields:active {
                transform: scale(0.92);
                background: #e2e2e2;
            }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 1;
        }

        .parcelas-container {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 280ms ease, opacity 200ms ease;
        }

            .parcelas-container.open {
                max-height: 80px; /* ajuste para a altura real */
                opacity: 1;
            }

        .divParcelas {
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .divParcelas label {
                margin-right: 5px;
                font-weight: bold;
            }

            .divParcelas .form-input {
                width: 50px;
                text-align: center;
                padding: 5px;
            }

        .btn-icon {
            font-size: 24px;
            font-weight: bold;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: #f0f0f0;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

            .btn-icon:focus {
                outline: none;
                box-shadow: none;
            }

        .divParcelas .form-input {
            width: 60px;
        }

    </style>
}

@RenderSection("style", required: false)
<div class="overview-shell">
    <div class="overview-content">
        @RenderBody()
    </div>

    <div id="addButton">
        <div class="add-plus">+</div>

        @if (_overview_IsMesAnterior)
        {
            <div class="period-badge">
                Período anterior
            </div>
        }
    </div>
</div>

<div id="addOverlay">
    <div class="overlay-topbar">
        <i id="backOverlayButton"
           class="fas fa-arrow-left back-icon"
           title="Voltar"></i>

        <span id="mesReferencia">@_overview_dataLancto.ToShortDateString()</span>

        <button id="closeOverlayButton" onclick="closeOverlay()">
            <img class="close-icon" src="/icons/xmark.svg" />
        </button>
    </div>

    <div class="overlay-content">
        <!-- Tela inicial -->
        <div id="overlayHome">
            <button class="overlay-option" id="btnReceita" data-type="receita">@string.Format("{0} Receita", acao)</button>
            <button class="overlay-option" id="btnDespesa" data-type="despesa">@string.Format("{0} Despesa", acao)</button>
        </div>

        <!-- Tela do formulário -->
        <div id="overlayFrame"></div>
    </div>
</div>


<button id="btnAdvancedFields"><i class="fas fa-gear"></i></button>

<div class="form-container" id="divAdvancedFields" style="display: none">
    <div class="form-group">
        <label for="DataMovto">Data:</label>
        <input type="date" id="DataMovto" name="DataMovto"
               required class="form-input" />
    </div>
    <div class="form-group">
        <label for="Descricao">Descrição:</label>
        <input type="text" id="Descricao"
               name="Descricao"
               class="form-input" />
    </div>

    @if (isAgenda)
    {
        <div class="form-group editParcelas">
            <input type="hidden" name="Parcela" />
            <input type="hidden" name="IDRecorrencia" />
            <div class="form-inline">
                <label class="switch swtRecorrente">
                    <input type="checkbox" class="chkRecorrente" name="Recorrente" />
                    <span class="slider"></span>
                </label>
                <label for="chkRecorrente">Recorrente</label>

                <div class="parcelas-container">
                    <div class="divParcelas">
                        <laber for="QtdParcelas">Parcelas:</laber>
                        <button type="button" class="recorrenteMenos btn-icon">-</button>
                        <input type="text"
                               name="QtdParcelas"
                               class="QtdParcelas form-input"
                               data-mask="##0"
                               data-mask-reverse="true"
                               value="1"/>
                        <button type="button" class="recorrenteMais btn-icon">+</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="showParcelas">
            <div class="form-inline">
                <span>Parcela: </span>
                <span class="textParcelas">1/1</span>
            </div>
        </div>
    }

</div>


@section script {
    <script>
        let editMode = false;
        let objMovto = null;
        let overlayHistory = [];
        const dateFormated = '@(_overview_dataLancto.ToString("yyyy-MM-dd"))';
        const urlBase = "@urlBase";
        const isAgenda = urlBase === "agenda";

        function loadComponent(url, adv) {
            pushOverlay(url);
            $.get(url, function (html) {
                $("#overlayFrame").html(html).show();
                $("#overlayHome").hide();
                if (editMode) {
                    $("#backOverlayButton").hide();
                    $('#mesReferencia').hide();
                }
                else {
                    $("#backOverlayButton").show();
                    $('#mesReferencia').show();
                }
            });
            if (adv)
                $('#btnAdvancedFields').show();
            else
                $('#btnAdvancedFields').hide();
        }

        function openOverlayView(htmlContent) {
            $("#addOverlay").html(htmlContent);
        }

        function closeOverlay() {
            editMode = false;
            $('#btnAdvancedFields').hide();
            $("#addOverlay").removeClass("active");
            $("#addButton").removeClass("hidden");
        }

        function pushOverlay(url) {
            if (overlayHistory[overlayHistory.length - 1] === url) return;
            overlayHistory.push(url);
        }

        function goBackOverlay() {
            // tira a view atual do topo
            overlayHistory.pop();

            const previous = overlayHistory[overlayHistory.length - 1];

            if (!previous) {
                // histórico vazio → volta ao início
                $("#overlayFrame").html("").hide();
                $("#overlayHome").show();
                $("#backOverlayButton").hide();
                return;
            }

            // carrega view anterior
            loadComponent(previous);
            $("#backOverlayButton").toggle(overlayHistory.length > 0);
        }

        function editOverlay(id) {
            editMode = true;
            $("#addOverlay").addClass("active");
            $("#overlayHome").hide();
            $("#overlayFrame").hide();
            $("#backOverlayButton").hide();
            overlayHistory = [];   // limpa histórico ao editar
            
            let url = `/${urlBase}/getmovto/${id}`; 
            objMovto = null;
            $.get(url, function (movto) {
                if (!movto) return;

                if (isAgenda) {
                    objMovto = {
                        ID: movto.ID,
                        TipoMovto: movto.TipoMovto,
                        IDGrupo: movto.IDGrupo,
                        DataMovto: movto.DataVencto,
                        Descricao: movto.Descricao,
                        ValorMovto: movto.ValorParcela,
                        Recorrente: movto.Recorrente,
                        IDRecorrencia: movto.IDRecorrencia,
                        Parcela: movto.Parcela,
                        QtdParcelas: movto.QtdParcelas
                    };
                }
                else {
                    objMovto = {
                        ID: movto.ID,
                        TipoMovto: movto.TipoMovto,
                        IDGrupo: movto.IDGrupo,
                        DataMovto: movto.DataMovto,
                        Descricao: movto.Descricao,
                        ValorMovto: movto.ValorMovto
                    };
                }
                
                let descricao = movto.Descricao ? movto.Descricao : movto.NomeGrupo;
                let digUrl = `/${urlBase}/digitarvalor/${descricao}/${objMovto.ValorMovto}`;

                loadComponent(digUrl, true);
            });
        }

        $(document).ready(function () {
            // abrir overlay no modo HOME
            $("#addButton").on("click", function () {
                editMode = false;
                $("#addOverlay").addClass("active");
                $("#overlayHome").show();
                $("#overlayFrame").hide();
                $("#backOverlayButton").hide();
                overlayHistory = [];   // limpa histórico ao abrir
            });

            // fechar overlay
            $("#closeOverlayButton").on("click", function () {
                $("#addOverlay").removeClass("active");
            });

            // escolher entre RECEITA e DESPESA
            $(".overlay-option").on("click", function () {
                const tipo = $(this).data("type");
                let url = tipo === "receita" ? 
                          `/${urlBase}/novareceita/${dateFormated}` :
                          `/${urlBase}/novadespesa/${dateFormated}`;
                objMovto = {
                    DataMovto: new Date(dateFormated).toISOString(),
                    TipoMovto: (tipo === "receita" ? 0 : 1),
                    IsAgenda: (isAgenda),
                    Recorrente: false,
                    Parcela: 1,
                    QtdParcelas: 1
                };

                loadComponent(url);
            });

            $("#backOverlayButton").on("click", function () {
                goBackOverlay();
            });

            function closeOverlayAndReload() {
                closeOverlay();
                window.location.reload();
            }

            $('#btnAdvancedFields').on('click', function () {
                const $clone = $('#divAdvancedFields')
                    .clone(false)   // 🔑 NÃO clone eventos
                    .removeAttr('id')
                    .show();

                // estado inicial
                if (objMovto.DataMovto)
                    $clone.find('[name="DataMovto"]').val(objMovto.DataMovto.split('T')[0]);
                if (objMovto.Descricao)
                    $clone.find('[name="Descricao"]').val(objMovto.Descricao);

                if (objMovto.Recorrente)
                    $clone.find('[name="Recorrente"]').prop('checked', objMovto.Recorrente === true);
                if (objMovto.Parcela)
                    $clone.find('[name="Parcela"]').val(objMovto.Parcela);
                if (objMovto.QtdParcelas)
                    $clone.find('[name="QtdParcelas"]').val(objMovto.QtdParcelas);
                if (objMovto.IDRecorrencia)
                    $clone.find('[name="IDRecorrencia"]').val(objMovto.IDRecorrencia);

                // eventos internos do clone
                $(document).on('change', '.chkRecorrente', function () {
                    const scope = $(this).closest('.form-container');
                    toggleParcelas(scope);
                });
                toggleParcelas($clone);

                // regra visual para edição
                if (editMode === true) {
                    $clone.find('.editParcelas').hide();
                    $clone.find('.showParcelas').show();

                    const parcela = objMovto.Parcela || 1;
                    const qtd = objMovto.QtdParcelas || 1;

                    $clone.find('.textParcelas').text(`${parcela}/${qtd}`);
                } else {
                    $clone.find('.editParcelas').show();
                    $clone.find('.showParcelas').hide();
                }

                showFormModal({
                    titulo: 'Dados avançados',
                    bodyHtml: $clone,
                    onSubmit: (formData) => {
                        objMovto.Descricao = formData.Descricao;
                        objMovto.DataMovto = formData.DataMovto;
                        objMovto.Recorrente = !!formData.Recorrente;
                        objMovto.IDRecorrencia = formData.IDRecorrencia;
                        objMovto.Parcela = parseInt(formData.Parcela || 1, 10);
                        objMovto.QtdParcelas = parseInt(formData.QtdParcelas || 1, 10);
                        @if (IsFreeMode)
                        {
                            <text>
                            if (objMovto.QtdParcelas > 2)
                            {
                                ShowLimiteParcelasMessage();
                                objMovto.QtdParcelas = 2;
                            }
                            </text>
                        }
                    }
                });
            });

            function ShowLimiteParcelasMessage() {
                const titulo = "O futuro já está no seu radar";
                const mens = `
                    <p>
                        No <strong>Pulse gratuito</strong>, você pode planejar compromissos
                        para o mês atual e o próximo — o suficiente para manter o controle
                        do curto prazo.
                    </p>
                    <br>
                    <p>
                        A partir daí, o planejamento de médio e longo prazo fica disponível
                        na <strong>versão completa</strong>, onde você pode agendar com mais
                        parcelas e mais meses à frente, com total liberdade.
                    </p>
                `;
                ShowFreeModeModal(titulo, mens);
            }

            $(document).on('click', '.recorrenteMais', function () {
                const input = $(this)
                    .closest('.divParcelas')
                    .find('.QtdParcelas');

                const valor = parseInt(input.val(), 10) || 0;
                @if (IsFreeMode) 
                {
                    <text>
                    if (valor >= 2)
                    {
                        ShowLimiteParcelasMessage();
                        return;
                    }
                    </text>
                }
                input.val(valor + 1);
            });

            $(document).on('click', '.recorrenteMenos', function () {
                const input = $(this)
                    .closest('.divParcelas')
                    .find('.QtdParcelas');

                const valor = parseInt(input.val(), 10) || 0;
                if (valor > 1) input.val(valor - 1);
            });

            $(document).on('blur', '.QtdParcelas', function () {
                let val = parseInt($(this).val(), 10);
                if (isNaN(val) || val <= 0) {
                    $(this).val('1');
                }
            });

            function toggleParcelas(scope) {
                const container = scope.find('.parcelas-container');
                const chk = scope.find('.chkRecorrente');
                container.toggleClass('open', chk.is(':checked'));
            }

            window.overlayComponentDone = function (payload) {
                if (!objMovto) return;

                if (payload.Step === "grupo") {
                    objMovto.IDGrupo = payload.IDGrupo;
                    objMovto.Descricao = "";
                    objMovto.DataMovto = dateFormated;

                    loadComponent(`/${urlBase}/DigitarValor/${payload.DescGrupo}`, true);
                }
                
                else if (payload.Step === "valor") {
                    objMovto.ValorMovto = payload.ValorMovto;

                    console.log(JSON.stringify(objMovto));

                    $.ajax({
                        url: `/${urlBase}/save`,
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(objMovto),
                        success: function (response) {
                            if (response.RedirectUrl) {
                                window.location.href = response.RedirectUrl;
                            }
                            closeOverlayAndReload();
                        },
                        error: function (xhr, status, error) {
                            ExibeErro(xhr);
                        }
                    });
                }
            }

            $('#btnAdvancedFields').hide();
        });
    </script>
}

@RenderSection("script", required: false)